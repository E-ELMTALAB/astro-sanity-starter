---
import Section from '@components/Section.astro';
import type { FlashSaleSection } from 'types';
import { buildCheckoutUrl } from '@utils/telegram-shop';

interface Props extends FlashSaleSection {
    'data-sb-field-path'?: string;
}

const { heading, subtitle, endsIn, items, 'data-sb-field-path': fieldPath, ...rest } = Astro.props;
const products = Array.isArray(items) ? items : [];
---

{(heading || subtitle || endsIn || products.length) ? (
    <Section {...rest} data-sb-field-path={fieldPath} class="space-y-6">
        <div class="space-y-3">
            {heading && (
                <h2 class="text-3xl font-bold" data-sb-field-path=".heading">
                    {heading}
                </h2>
            )}
            {subtitle && (
                <p class="text-base opacity-80" data-sb-field-path=".subtitle">
                    {subtitle}
                </p>
            )}
            {endsIn && (
                <p class="text-sm text-error" data-sb-field-path=".endsIn">
                    Ends in {endsIn}
                </p>
            )}
        </div>
        {products.length ? (
            <div class="grid grid-cols-1 gap-6 md:grid-cols-2 xl:grid-cols-3" data-sb-field-path=".items">
                {products.map((product, idx) => {
                    const checkoutHref = buildCheckoutUrl(product?.productSlug, product?.variantSku);
                    const href = checkoutHref ?? product?.url ?? undefined;
                    return (
                        <article
                            class="flex h-full flex-col gap-4 rounded-2xl border border-base-200 bg-base-100 p-6 shadow-sm"
                            data-sb-field-path={`.${idx}`}
                        >
                            {product?.image?.src && (
                                <div class="overflow-hidden rounded-xl" data-sb-field-path=".image">
                                    <img
                                        src={product.image.src}
                                        alt={product.image.alt}
                                        class="h-48 w-full object-cover"
                                        loading="lazy"
                                        data-sb-object-id={product.image._id}
                                    />
                                </div>
                            )}
                            <div class="space-y-2">
                                {product?.name && (
                                    <h3 class="text-xl font-semibold" data-sb-field-path=".name">
                                        {product.name}
                                    </h3>
                                )}
                                {product?.description && (
                                    <p class="text-sm opacity-80" data-sb-field-path=".description">
                                        {product.description}
                                    </p>
                                )}
                                <div class="flex flex-wrap items-center gap-3 text-sm">
                                    {typeof product?.price === 'number' && (
                                        <span class="text-2xl font-bold text-primary" data-sb-field-path=".price">
                                            ${product.price}
                                        </span>
                                    )}
                                    {typeof product?.originalPrice === 'number' && (
                                        <span class="text-base line-through opacity-60" data-sb-field-path=".originalPrice">
                                            ${product.originalPrice}
                                        </span>
                                    )}
                                    {typeof product?.discount === 'number' && (
                                        <span class="badge badge-secondary" data-sb-field-path=".discount">
                                            -{product.discount}%
                                        </span>
                                    )}
                                </div>
                                <div class="flex flex-wrap items-center gap-2 text-xs opacity-70">
                                    {product?.category && (
                                        <span data-sb-field-path=".category">{product.category}</span>
                                    )}
                                    {typeof product?.rating === 'number' && (
                                        <span data-sb-field-path=".rating">{product.rating}â˜…</span>
                                    )}
                                </div>
                            </div>
                            {href && (
                                <a href={href} class="btn btn-primary mt-auto" data-sb-field-path=".productSlug">
                                    Buy now
                                    {product?.productSlug && (
                                        <span class="hidden" aria-hidden="true" data-sb-field-path=".productSlug">
                                            {product.productSlug}
                                        </span>
                                    )}
                                    {product?.variantSku && (
                                        <span class="hidden" aria-hidden="true" data-sb-field-path=".variantSku">
                                            {product.variantSku}
                                        </span>
                                    )}
                                    {product?.url && !checkoutHref && (
                                        <span class="hidden" aria-hidden="true" data-sb-field-path=".url">
                                            {product.url}
                                        </span>
                                    )}
                                </a>
                            )}
                        </article>
                    );
                })}
            </div>
        ) : null}
    </Section>
) : null}
