---
import type { Page } from 'types';
import Layout from '@layouts/Layout.astro';
import TelegramShopHome from '@components/TelegramShopHome.tsx';
import { fetchData, getPageById } from '@data/page';

export async function getStaticPaths() {
    const data = await fetchData();
    return data.map((page: Page) => {
        const slug = page.slug.current === '/' ? undefined : page.slug.current;
        return {
            params: { slug },
            props: { id: page._id }
        };
    });
}

const { id } = Astro.props;
const pages = await getPageById(id);
const page: Page | null = pages.length ? pages[0] : null;

const { _id, title, sections, metaTitle, metaDescription, socialImage } = page || {};


// Find sections in the correct order to match the fallback data structure
const findSectionByType = (type: string) => {
    if (!Array.isArray(sections)) return { section: null, index: -1 };
    const index = sections.findIndex((s: any) => s?._type === type);
    return { section: index >= 0 ? sections[index] : null, index };
};

// Find sections in the correct order (matching fallback data structure)
const { section: heroCarouselSection, index: heroCarouselIndex } = findSectionByType('heroCarouselSection');
const { section: storiesSection, index: storiesIndex } = findSectionByType('storiesSection');
const { section: categoriesSection, index: categoriesIndex } = findSectionByType('categoriesSection');
const { section: flashSaleSection, index: flashSaleIndex } = findSectionByType('flashSaleSection');
const { section: featuredSection, index: featuredIndex } = findSectionByType('featuredProductsSection');
const { section: supportSection, index: supportIndex } = findSectionByType('supportSection');

---

{
    page && (
        <Layout title={metaTitle ?? title} description={metaDescription} image={socialImage}>
            <div data-sb-object-id={_id}>
                <TelegramShopHome
                    client:load
                    stories={storiesSection}
                    storiesFieldPath={storiesIndex >= 0 ? `sections.${storiesIndex}` : undefined}
                    heroCarousel={heroCarouselSection}
                    heroCarouselFieldPath={heroCarouselIndex >= 0 ? `sections.${heroCarouselIndex}` : undefined}
                    categories={categoriesSection}
                    categoriesFieldPath={categoriesIndex >= 0 ? `sections.${categoriesIndex}` : undefined}
                    flashSale={flashSaleSection}
                    flashSaleFieldPath={flashSaleIndex >= 0 ? `sections.${flashSaleIndex}` : undefined}
                    featured={featuredSection}
                    featuredFieldPath={featuredIndex >= 0 ? `sections.${featuredIndex}` : undefined}
                    support={supportSection}
                    supportFieldPath={supportIndex >= 0 ? `sections.${supportIndex}` : undefined}
                /> 
            </div>
        </Layout>
    )
}
